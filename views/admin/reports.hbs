<div class="container-fluid">
  <main role="main" class="col-md-9 ml-sm-auto col-lg-10 pt-3 px-4 row">
    <h2>Reports</h2>
    <hr class="mt-5 mb-5">

    <div class="card-columns">
      <div class="card bg-light">
        <div class="card-body text-center">
          <h4 class="cart-text">Total no. of customers</h4>
          <p class="card-text">{{user_count}} ({{userInWords}})</p>
        </div>
      </div>
      <div class="card bg-info">
        <div class="card-body text-center">
          <h4 class="cart-text">Total no. of Products</h4>
          <p class="card-text">{{product_count}} ({{productInWords}})</p>
        </div>
      </div>
      <div class="card bg-warning">
        <div class="card-body text-center">
          <h4 class="cart-text">Total no. of categories</h4>
          <p class="card-text">{{category_count}} ({{categoryInWords}})</p>
        </div>
      </div>

    </div>
    <div class="pt-5">
      <h2>Sales Reports( custom date )</h2>
      {{!-- <p>The .table-bordered class adds borders to a table:</p> --}}
      <div class="mb-5 mt-5 d-flex justify-content-center">
        <span class="mr-2">Start date<input class="ml-2" id="start-date" type="date" value=""></span>
        <span class="ml-2">End date<input class="ml-2" id="end-date" type="date" value=""></span>
        <button id="getReport" class="ml-2 btn btn-light">submit</button>
      </div>
      <table class="table table-bordered" >
        <thead>
          <tr>
            <th>Date</th>
            <th>Total Orders</th>
            <th>Total products sold</th>
            <th>Amount</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td id="selected-date"></td>
            <td id="total-orders"></td>
            <td id="total-products"></td>
            <td id="total-amount"></td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="pt-5">
      <h2>Order Reports( By period )</h2>
      {{!-- <p>The .table-bordered class adds borders to a table:</p> --}}
      <div class="mb-5 mt-5 d-flex ">
        <div class="dropdown">
          <button class="btn btn-light dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown"
            aria-haspopup="true" aria-expanded="false">
            select a period
          </button>
          <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
            <button class="dropdown-item" onclick="getOrderByPeriod(7)">Last week</button>
            <button class="dropdown-item" onclick="getOrderByPeriod(30)">Last month</button>
            <button class="dropdown-item" onclick="getOrderByPeriod(365)">Last year</button>
          </div>
        </div>
      </div>
      <div class="table-responsive">
      <table class="table table-bordered table-sm" id="report-table">
        <thead>
          <tr>
            <th>customer</th>
            <th>phone</th>
            <th>Address</th>
            <th>order id</th>
            <th>order date</th>
            <th>payment method</th>
            <th>payment status</th>
            <th>shipment status</th>
          </tr>
        </thead>
      </table>
    </div>
    </div>


    <div class=" pt-5">
      <h2>Cancelled Orders</h2>
      {{#if cancel_orders}}
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>customer</th>
            <th>phone</th>
            <th>Address</th>
            <th>order id</th>
            <th>order date</th>
            <th>payment method</th>
            <th>payment status</th>
            <th>shipment status</th>
            <th>ship address</th>
          </tr>
        </thead>
        <tbody>
          {{#each cancel_orders}}
          <tr>
            <td>{{this.deliveryDetails.name}}</td>
            <td>{{this.deliveryDetails.phone}}</td>
            <th>{{this.deliveryDetails.address}}</th>
            <td>{{this._id}}</td>
            <td>{{this.date}}</td>
            <td>{{this.paymentMethod}}</td>
            <td>{{this.payment_status}}</td>
            <td>{{this.shipment_status}}</td>
            <th>
              <a id="confirm-id-{{this._id}}" href="/admin/shipCancelOrder/{{this._id}}"><button class="btn btn-success"
                  onclick="return confirm('are you sure ?')"> ship order</button></a>
            </th>
          </tr>
          {{/each}}
        </tbody>
      </table>
      {{/if}}
    </div>
  </main>
</div>

<!-- Icons -->
<script src="https://unpkg.com/feather-icons/dist/feather.min.js"></script>
<script>
  feather.replace()
</script>

<script>
  $('#getReport').click(function () {
    let startDate = $('#start-date').val();
    let endDate = $('#end-date').val();
    console.log(startDate, endDate);

    $.ajax({
      url: '/admin/ajax/reports',
      method: 'post',
      data: {
        "startDate": startDate,
        "endDate": endDate
      },
      success: (response) => {
        console.log(response.reports)
        if (response.reports) {
          document.getElementById('selected-date').innerHTML = startDate + " to " + endDate;
          document.getElementById('total-orders').innerHTML = response.reports.total_orders
          document.getElementById('total-products').innerHTML = response.reports.total_products
          document.getElementById('total-amount').innerHTML = "â‚¹ " + response.reports.total_amount
        }
      }
    })
  })

  function getOrderByPeriod(period) {
    console.log(period);
    $.ajax({
      url: '/admin/ordersByPeriod',
      data: period,
      method: "post",
      success: (response) => {
        console.log(response.orders)
        // here we populate data returned by controller
        // if returned data is a plain array, then parse into javascript obj
        var d = (response.orders);
        // d = [{ name : 'john', phone : 123 }]; --> example
        // this depend on your returned data from controller
        var output;
        $.each(d, function (i, e) {
          // here you structured the code depend on the table of yours
          output += '<tr><td>' + e.deliveryDetails.name + '</td><td>' + e.deliveryDetails.phone + '</td><td>' + e.deliveryDetails.address + '</td><td>' + e._id + '</td><td>' + e.date + '</td><td>' + e.paymentMethod + '</td><td>' + e.payment_status + '</td><td>' + e.shipment_status + '</td></tr>';
        });

        // after finish creating html structure, append the output
        // into the table
        $('#report-table').append(output);

      }
    })
  }
</script>